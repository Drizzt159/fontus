<!doctype html>
<html lang="en">
  <head>
    <title>Watering System</title>
  </head>
  <body>
    <h1>Watering System</h1>

    <div id="schedule">
      <h4>Schedule</h4>

      <table>
        <thead>
          <tr>
            <th>Hour</th>
            <th>0</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
            <th>8</th>
            <th>9</th>
            <th>10</th>
            <th>11</th>
            <th>12</th>
            <th>13</th>
            <th>14</th>
            <th>15</th>
            <th>16</th>
            <th>17</th>
            <th>18</th>
            <th>19</th>
            <th>20</th>
            <th>21</th>
            <th>22</th>
            <th>23</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>On</td>
            <td><input id="0-on" type="checkbox"></td>
            <td><input id="1-on" type="checkbox"></td>
            <td><input id="2-on" type="checkbox"></td>
            <td><input id="3-on" type="checkbox"></td>
            <td><input id="4-on" type="checkbox"></td>
            <td><input id="5-on" type="checkbox"></td>
            <td><input id="6-on" type="checkbox"></td>
            <td><input id="7-on" type="checkbox"></td>
            <td><input id="8-on" type="checkbox"></td>
            <td><input id="9-on" type="checkbox"></td>
            <td><input id="10-on" type="checkbox"></td>
            <td><input id="11-on" type="checkbox"></td>
            <td><input id="12-on" type="checkbox"></td>
            <td><input id="13-on" type="checkbox"></td>
            <td><input id="14-on" type="checkbox"></td>
            <td><input id="15-on" type="checkbox"></td>
            <td><input id="16-on" type="checkbox"></td>
            <td><input id="17-on" type="checkbox"></td>
            <td><input id="18-on" type="checkbox"></td>
            <td><input id="19-on" type="checkbox"></td>
            <td><input id="20-on" type="checkbox"></td>
            <td><input id="21-on" type="checkbox"></td>
            <td><input id="22-on" type="checkbox"></td>
            <td><input id="23-on" type="checkbox"></td>
          </tr>

          <tr>
            <td>Off</td>
            <td><input id="0-off" type="checkbox"></td>
            <td><input id="1-off" type="checkbox"></td>
            <td><input id="2-off" type="checkbox"></td>
            <td><input id="3-off" type="checkbox"></td>
            <td><input id="4-off" type="checkbox"></td>
            <td><input id="5-off" type="checkbox"></td>
            <td><input id="6-off" type="checkbox"></td>
            <td><input id="7-off" type="checkbox"></td>
            <td><input id="8-off" type="checkbox"></td>
            <td><input id="9-off" type="checkbox"></td>
            <td><input id="10-off" type="checkbox"></td>
            <td><input id="11-off" type="checkbox"></td>
            <td><input id="12-off" type="checkbox"></td>
            <td><input id="13-off" type="checkbox"></td>
            <td><input id="14-off" type="checkbox"></td>
            <td><input id="15-off" type="checkbox"></td>
            <td><input id="16-off" type="checkbox"></td>
            <td><input id="17-off" type="checkbox"></td>
            <td><input id="18-off" type="checkbox"></td>
            <td><input id="19-off" type="checkbox"></td>
            <td><input id="20-off" type="checkbox"></td>
            <td><input id="21-off" type="checkbox"></td>
            <td><input id="22-off" type="checkbox"></td>
            <td><input id="23-off" type="checkbox"></td>
          </tr>
        </tbody>
      </table>

      <button id="update">Update</button>
    </div>

    <div class="manual">
      <h1>Manual Control</h1>
      <button id="on">On</button>
      <button id="off">Off</button>
    </div>

    <div id="moisture">
      <h1>Moisture</h1>
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Sensor</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          $MOISTUREDATA$
        </tbody>
      </table>
    </div>

    <script>
      // superagent HTTP package
      !function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.request=t()}}(function(){return function t(e,r,n){function i(s,a){if(!r[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var h=new Error("Cannot find module '"+s+"'");throw h.code="MODULE_NOT_FOUND",h}var c=r[s]={exports:{}};e[s][0].call(c.exports,function(t){var r=e[s][1][t];return i(r?r:t)},c,c.exports,t,e,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(t,e){function r(t){return t?n(t):void 0}function n(t){for(var e in r.prototype)t[e]=r.prototype[e];return t}e.exports=r,r.prototype.on=r.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks[t]=this._callbacks[t]||[]).push(e),this},r.prototype.once=function(t,e){function r(){n.off(t,r),e.apply(this,arguments)}var n=this;return this._callbacks=this._callbacks||{},r.fn=e,this.on(t,r),this},r.prototype.off=r.prototype.removeListener=r.prototype.removeAllListeners=r.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var r=this._callbacks[t];if(!r)return this;if(1==arguments.length)return delete this._callbacks[t],this;for(var n,i=0;i<r.length;i++)if(n=r[i],n===e||n.fn===e){r.splice(i,1);break}return this},r.prototype.emit=function(t){this._callbacks=this._callbacks||{};var e=[].slice.call(arguments,1),r=this._callbacks[t];if(r){r=r.slice(0);for(var n=0,i=r.length;i>n;++n)r[n].apply(this,e)}return this},r.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks[t]||[]},r.prototype.hasListeners=function(t){return!!this.listeners(t).length}},{}],2:[function(t,e){e.exports=function(t,e,r){for(var n=0,i=t.length,o=3==arguments.length?r:t[n++];i>n;)o=e.call(null,o,t[n],++n,t);return o}},{}],3:[function(t,e){function r(){}function n(t){var e={}.toString.call(t);switch(e){case"[object File]":case"[object Blob]":case"[object FormData]":return!0;default:return!1}}function i(t){return t===Object(t)}function o(t){if(!i(t))return t;var e=[];for(var r in t)null!=t[r]&&e.push(encodeURIComponent(r)+"="+encodeURIComponent(t[r]));return e.join("&")}function s(t){for(var e,r,n={},i=t.split("&"),o=0,s=i.length;s>o;++o)r=i[o],e=r.split("="),n[decodeURIComponent(e[0])]=decodeURIComponent(e[1]);return n}function a(t){var e,r,n,i,o=t.split(/\r?\n/),s={};o.pop();for(var a=0,u=o.length;u>a;++a)r=o[a],e=r.indexOf(":"),n=r.slice(0,e).toLowerCase(),i=m(r.slice(e+1)),s[n]=i;return s}function u(t){return t.split(/ *; */).shift()}function h(t){return d(t.split(/ *; */),function(t,e){var r=e.split(/ *= */),n=r.shift(),i=r.shift();return n&&i&&(t[n]=i),t},{})}function c(t,e){e=e||{},this.req=t,this.xhr=this.req.xhr,this.text="HEAD"!=this.req.method&&(""===this.xhr.responseType||"text"===this.xhr.responseType)||"undefined"==typeof this.xhr.responseType?this.xhr.responseText:null,this.statusText=this.req.xhr.statusText,this.setStatusProperties(this.xhr.status),this.header=this.headers=a(this.xhr.getAllResponseHeaders()),this.header["content-type"]=this.xhr.getResponseHeader("content-type"),this.setHeaderProperties(this.header),this.body="HEAD"!=this.req.method?this.parseBody(this.text?this.text:this.xhr.response):null}function p(t,e){var r=this;f.call(this),this._query=this._query||[],this.method=t,this.url=e,this.header={},this._header={},this.on("end",function(){var t=null,e=null;try{e=new c(r)}catch(e){return t=new Error("Parser is unable to parse the response"),t.parse=!0,t.original=e,r.callback(t)}if(r.emit("response",e),t)return r.callback(t,e);if(e.status>=200&&e.status<300)return r.callback(t,e);var n=new Error(e.statusText||"Unsuccessful HTTP response");n.original=t,n.response=e,n.status=e.status,r.callback(n,e)})}function l(t,e){return"function"==typeof e?new p("GET",t).end(e):1==arguments.length?new p("GET",t):new p(t,e)}var f=t("emitter"),d=t("reduce"),y="undefined"==typeof window?this||self:window;l.getXHR=function(){if(!(!y.XMLHttpRequest||y.location&&"file:"==y.location.protocol&&y.ActiveXObject))return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){}return!1};var m="".trim?function(t){return t.trim()}:function(t){return t.replace(/(^\s*|\s*$)/g,"")};l.serializeObject=o,l.parseString=s,l.types={html:"text/html",json:"application/json",xml:"application/xml",urlencoded:"application/x-www-form-urlencoded",form:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"},l.serialize={"application/x-www-form-urlencoded":o,"application/json":JSON.stringify},l.parse={"application/x-www-form-urlencoded":s,"application/json":JSON.parse},c.prototype.get=function(t){return this.header[t.toLowerCase()]},c.prototype.setHeaderProperties=function(){var t=this.header["content-type"]||"";this.type=u(t);var e=h(t);for(var r in e)this[r]=e[r]},c.prototype.parseBody=function(t){var e=l.parse[this.type];return e&&t&&(t.length||t instanceof Object)?e(t):null},c.prototype.setStatusProperties=function(t){1223===t&&(t=204);var e=t/100|0;this.status=t,this.statusType=e,this.info=1==e,this.ok=2==e,this.clientError=4==e,this.serverError=5==e,this.error=4==e||5==e?this.toError():!1,this.accepted=202==t,this.noContent=204==t,this.badRequest=400==t,this.unauthorized=401==t,this.notAcceptable=406==t,this.notFound=404==t,this.forbidden=403==t},c.prototype.toError=function(){var t=this.req,e=t.method,r=t.url,n="cannot "+e+" "+r+" ("+this.status+")",i=new Error(n);return i.status=this.status,i.method=e,i.url=r,i},l.Response=c,f(p.prototype),p.prototype.use=function(t){return t(this),this},p.prototype.timeout=function(t){return this._timeout=t,this},p.prototype.clearTimeout=function(){return this._timeout=0,clearTimeout(this._timer),this},p.prototype.abort=function(){return this.aborted?void 0:(this.aborted=!0,this.xhr.abort(),this.clearTimeout(),this.emit("abort"),this)},p.prototype.set=function(t,e){if(i(t)){for(var r in t)this.set(r,t[r]);return this}return this._header[t.toLowerCase()]=e,this.header[t]=e,this},p.prototype.unset=function(t){return delete this._header[t.toLowerCase()],delete this.header[t],this},p.prototype.getHeader=function(t){return this._header[t.toLowerCase()]},p.prototype.type=function(t){return this.set("Content-Type",l.types[t]||t),this},p.prototype.accept=function(t){return this.set("Accept",l.types[t]||t),this},p.prototype.auth=function(t,e){var r=btoa(t+":"+e);return this.set("Authorization","Basic "+r),this},p.prototype.query=function(t){return"string"!=typeof t&&(t=o(t)),t&&this._query.push(t),this},p.prototype.field=function(t,e){return this._formData||(this._formData=new y.FormData),this._formData.append(t,e),this},p.prototype.attach=function(t,e,r){return this._formData||(this._formData=new y.FormData),this._formData.append(t,e,r),this},p.prototype.send=function(t){var e=i(t),r=this.getHeader("Content-Type");if(e&&i(this._data))for(var o in t)this._data[o]=t[o];else"string"==typeof t?(r||this.type("form"),r=this.getHeader("Content-Type"),this._data="application/x-www-form-urlencoded"==r?this._data?this._data+"&"+t:t:(this._data||"")+t):this._data=t;return!e||n(t)?this:(r||this.type("json"),this)},p.prototype.callback=function(t,e){var r=this._callback;this.clearTimeout(),r(t,e)},p.prototype.crossDomainError=function(){var t=new Error("Origin is not allowed by Access-Control-Allow-Origin");t.crossDomain=!0,this.callback(t)},p.prototype.timeoutError=function(){var t=this._timeout,e=new Error("timeout of "+t+"ms exceeded");e.timeout=t,this.callback(e)},p.prototype.withCredentials=function(){return this._withCredentials=!0,this},p.prototype.end=function(t){var e=this,i=this.xhr=l.getXHR(),o=this._query.join("&"),s=this._timeout,a=this._formData||this._data;this._callback=t||r,i.onreadystatechange=function(){if(4==i.readyState){var t;try{t=i.status}catch(e){t=0}if(0==t){if(e.timedout)return e.timeoutError();if(e.aborted)return;return e.crossDomainError()}e.emit("end")}};var u=function(t){t.total>0&&(t.percent=t.loaded/t.total*100),e.emit("progress",t)};this.hasListeners("progress")&&(i.onprogress=u);try{i.upload&&this.hasListeners("progress")&&(i.upload.onprogress=u)}catch(t){}if(s&&!this._timer&&(this._timer=setTimeout(function(){e.timedout=!0,e.abort()},s)),o&&(o=l.serializeObject(o),this.url+=~this.url.indexOf("?")?"&"+o:"?"+o),i.open(this.method,this.url,!0),this._withCredentials&&(i.withCredentials=!0),"GET"!=this.method&&"HEAD"!=this.method&&"string"!=typeof a&&!n(a)){var h=this.getHeader("Content-Type"),c=l.serialize[h?h.split(";")[0]:""];c&&(a=c(a))}for(var p in this.header)null!=this.header[p]&&i.setRequestHeader(p,this.header[p]);return this.emit("request",this),i.send(a),this},p.prototype.then=function(t,e){return this.end(function(r,n){r?e(r):t(n)})},l.Request=p,l.get=function(t,e,r){var n=l("GET",t);return"function"==typeof e&&(r=e,e=null),e&&n.query(e),r&&n.end(r),n},l.head=function(t,e,r){var n=l("HEAD",t);return"function"==typeof e&&(r=e,e=null),e&&n.send(e),r&&n.end(r),n},l.del=function(t,e){var r=l("DELETE",t);return e&&r.end(e),r},l.patch=function(t,e,r){var n=l("PATCH",t);return"function"==typeof e&&(r=e,e=null),e&&n.send(e),r&&n.end(r),n},l.post=function(t,e,r){var n=l("POST",t);return"function"==typeof e&&(r=e,e=null),e&&n.send(e),r&&n.end(r),n},l.put=function(t,e,r){var n=l("PUT",t);return"function"==typeof e&&(r=e,e=null),e&&n.send(e),r&&n.end(r),n},e.exports=l},{emitter:1,reduce:2}]},{},[3])(3)});
    </script>

    <script>
      var $ = document.getElementById.bind(document);

      function render(err, res) {
        if (err) { return console.error(err); }
        var schedule = res.body.data;

        Object.keys(schedule).forEach(function(hour) {
          ["on", "off"].forEach(function(state) {
            var elem = $("" + hour + "-" + state);

            if (schedule[hour][state] !== elem.checked) {
              elem.checked = schedule[hour][state];
            }
          });
        });
      }

      $("on").addEventListener("click", function() { request.get("/on").end(); });
      $("off").addEventListener("click", function() { request.get("/off").end(); });

      // request state of schedule from server
      request("/schedule", render);

      // update server when button pressed
      $("update").addEventListener("click", function() {
        var data = {};

        var checkboxes = document.getElementsByTagName("input");

        for (var i = 0; i < checkboxes.length; i++) {
          var checkbox = checkboxes[i],
              hour = checkbox.id.split("-")[0],
              state = checkbox.id.split("-")[1];

          data[hour] = data[hour] || {};
          data[hour][state] = checkbox.checked;
        }

        request.put("/schedule").send(data).end();
      });
    </script>
  </body>
</html>
